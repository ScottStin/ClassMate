<div *ngIf="createExamLoading" class="exam-form-loading-spinner-container">
  <mat-spinner></mat-spinner>
  <span>We're creating your exam now, please wait.</span>
</div>

<div *ngIf="createAiPromptLoading" class="exam-form-loading-spinner-container">
  <mat-spinner></mat-spinner>
</div>

<ng-container>
  <app-dialog-header
    [dialogTitle]="data.title"
    (closeAction)="closeDialog(null)"
  ></app-dialog-header>
  <mat-stepper
    [linear]="!data.exam"
    #stepper
    [class]="createExamLoading ? 'exam-form-loading-overlay' : ''"
  >
    <div [formGroup]="examForm">
      <!-- --- ------------- -->
      <!-- EXAM DETAILS STEP -->
      <!-- --- ------------- -->
      <mat-step
        *ngIf="examForm.controls['examDetailsStep'] as examDetailsStepForm"
        label="Exam Details"
        [stepControl]="examDetailsStepForm"
        formGroupName="examDetailsStep"
        [editable]="true"
      >
        <mat-dialog-content class="mat-typography" class="test">
          <!----- Exam Name: ----->
          <div class="row">
            <mat-form-field class="form-field" appearance="outline" class="col">
              <mat-label>Exam name</mat-label>
              <input
                matInput
                id="name"
                formControlName="name"
                type="text"
                placeholder="E.g. PTE Mini Mock Test 1"
                required
              />
              <mat-error>
                <app-error-message
                  [control]="examDetailsStepForm.controls['name'].errors"
                ></app-error-message>
              </mat-error>
            </mat-form-field>
          </div>

          <!----- Exam Description: ----->
          <div class="row">
            <mat-form-field class="form-field" appearance="outline" class="col">
              <mat-label>Exam description</mat-label>
              <textarea
                matInput
                id="description"
                formControlName="description"
                type="text"
                placeholder="Tell your students about this exam..."
                required
              ></textarea>
              <mat-error>
                <app-error-message
                  [control]="examDetailsStepForm.controls['description'].errors"
                ></app-error-message>
              </mat-error>
            </mat-form-field>
          </div>

          <!----- Exam Instructions: ----->
          <div class="row">
            <mat-form-field class="form-field" appearance="outline" class="col">
              <mat-label>Exam instructions</mat-label>
              <textarea
                matInput
                id="instructions"
                formControlName="instructions"
                type="text"
                placeholder="Optional instructions for the students that they will see before starting the exam."
                required
              ></textarea>
              <mat-error>
                <app-error-message
                  [control]="examDetailsStepForm.controls['instructions'].errors"
                ></app-error-message>
              </mat-error>
            </mat-form-field>
          </div>

          <!----- Exam Price: ----->
          <div class="row">
            <mat-form-field class="form-field" appearance="outline" class="col">
              <mat-label>Casual Price (USD)</mat-label>
              <input
                matInput
                id="casualPrice"
                formControlName="casualPrice"
                type="number"
                placeholder="The price that students without a subscription plan will pay for this exam (USD)"
              />
              <mat-icon matSuffix>attach_money</mat-icon>
              <mat-error>
                <app-error-message
                  [control]="examDetailsStepForm.controls['casualPrice'].errors"
                ></app-error-message>
              </mat-error>
            </mat-form-field>
          </div>

          <!----- Exam Total Points: ----->
          <div>
            <mat-form-field
              class="form-field"
              appearance="outline"
              class="col"
              style="width: 47.5%"
            >
              <mat-label>Total Points (min)</mat-label>
              <input
                matInput
                id="totalPointsMin"
                formControlName="totalPointsMin"
                type="number"
                placeholder="The smallest number of points a student can be awarded (e.g. 10 for PTE, 0 for IELTS, 80 for Cambridge etc.) Default is 0"
              />
              <mat-error>
                <app-error-message
                  [control]="examDetailsStepForm.controls['totalPointsMin'].errors"
                ></app-error-message>
              </mat-error>
            </mat-form-field>

            <span style="width: 10%">&nbsp; - &nbsp;</span>

            <mat-form-field
              class="form-field"
              appearance="outline"
              class="col"
              style="width: 47.5%"
            >
              <mat-label>Total Points (max)</mat-label>
              <input
                matInput
                id="totalPointsMax"
                formControlName="totalPointsMax"
                type="number"
                placeholder="The total amount of points this exam will be marked out of (e.g. 90 for PTE, 9 for IELTS, 230 for Cambridge etc.) Default is 100."
              />
              <mat-error>
                <app-error-message
                  [control]="examDetailsStepForm.controls['totalPointsMax'].errors"
                ></app-error-message>
              </mat-error>
            </mat-form-field>
          </div>

          <!----- Exam Teacher: ----->
          <div class="row">
            <mat-form-field appearance="outline" class="form-field" class="col">
              <mat-label>Assigned teacher</mat-label>
              <mat-select formControlName="assignedTeacherId">
                <mat-option
                  *ngFor="let teacher of data.teachers"
                  [value]="teacher._id"
                  ><img
                    [src]="teacher.profilePicture?.url"
                    alt="teacher image"
                    class="thumbnail-image"
                  />{{teacher.name}}</mat-option
                >
              </mat-select>
              <mat-icon
                matSuffix
                #tooltip="matTooltip"
                matTooltip="The assigned teacher will be responsible for marking this exam and giving feedback. Note that any teacher can mark any exam, but only the assigned teacher will be notified when an exam needs marking."
                >info_outlined</mat-icon
              >
              <mat-error>
                <app-error-message
                  [control]="examDetailsStepForm.controls['assignedTeacherId'].errors"
                ></app-error-message>
              </mat-error>
            </mat-form-field>
          </div>

          <!----- Exam Default Status: ----->
          <div class="row">
            <div class="form-field col">
              <mat-slide-toggle
                formControlName="default"
                id="default"
                #default
                name="default"
                (change)="default.checked ? updateDefaultExam() : ''"
              >
                Default level test?
                <mat-icon
                  style="font-size: 20px"
                  #tooltip="matTooltip"
                  matTooltip="This will be the free level test assigned to students when they first sign up for the platform."
                  >info_outlined</mat-icon
                >
              </mat-slide-toggle>
              <mat-error>
                <app-error-message
                  [control]="examDetailsStepForm.controls['default'].errors"
                ></app-error-message>
              </mat-error>
            </div>
          </div>
        </mat-dialog-content>

        <!----- Exam Step nav: ----->
        <mat-dialog-actions align="end">
          <button
            mat-raised-button
            class="button"
            matStepperNext
            type="button"
            [disabled]="examDetailsStepForm.invalid"
          >
            <b>Next</b>
          </button>
        </mat-dialog-actions>
      </mat-step>

      <!-- --- --------- -->
      <!-- QUESTION STEP -->
      <!-- --- --------- -->

      <mat-step
        *ngIf="examForm.controls['questionStep'] as questionStepForm"
        label="Add Questions to Exam"
        [editable]="true"
        [stepControl]="questionStepForm"
        formGroupName="questionStep"
        [editable]="true"
      >
        <mat-dialog-content class="mat-typography">
          <div class="row">
            <!----- ---------------------- ----->
            <!----- Question/Section List: ----->
            <!----- ---------------------- ----->

            <div
              [class]="questionList.length > 0 && currentQuestionDisplay ? 'col-sm-3' : 'col-sm-12'"
              class="question-list-container"
              [ngClass]="{
                  'expanded': questionList.length === 0 || !currentQuestionDisplay,
                  'border-right': questionList.length > 0 && currentQuestionDisplay
                }"
            >
              <div style="display: flex; flex-direction: column">
                <div class="tree-container">
                  <mat-list role="list" *ngFor="let question of questionList">
                    <!----- Question List: ----->
                    <mat-list-item role="listitem">
                      <div style="display: flex; align-items: center">
                        <span
                          [class]="question.tempId === currentQuestionDisplay?.tempId ? 'current-question' : ''"
                          >{{question.name}}</span
                        >
                        <mat-icon
                          style="
                            cursor: pointer;
                            font-size: 16px;
                            margin-left: 10px;
                          "
                          #tooltip="matTooltip"
                          [matTooltip]="'Edit ' + question.type"
                          (click)="editQuestion(question, null)"
                          [class]="question.tempId === currentQuestionDisplay?.tempId ? 'current-question' : ''"
                          >edit</mat-icon
                        >
                        <mat-icon
                          style="cursor: pointer; font-size: 16px"
                          #tooltip="matTooltip"
                          [matTooltip]="'Delete ' + question.type"
                          (click)="deleteQuestion(question, null)"
                          [class]="question.tempId === currentQuestionDisplay?.tempId ? 'current-question' : ''"
                          >delete</mat-icon
                        >
                        <mat-icon
                          style="cursor: pointer; font-size: 16px"
                          #tooltip="matTooltip"
                          [matTooltip]="'Preview ' + question.type"
                          (click)="previewQuestion()"
                          *ngIf="question.tempId === currentQuestionDisplay?.tempId"
                          [class]="question.tempId === currentQuestionDisplay?.tempId ? 'current-question' : ''"
                          >remove_red_eye</mat-icon
                        >
                        <span
                          *ngIf="question.subQuestions"
                          (click)="expandSection(question)"
                          style="cursor: pointer; margin-left: auto"
                        >
                          <mat-icon
                            [class]="question.expanded ? 'arrow-down' : 'arrow'"
                            >keyboard_arrow_right</mat-icon
                          >
                        </span>
                      </div></mat-list-item
                    >

                    <!----- Sub question list in sections: ----->
                    <div *ngIf="question.expanded">
                      <mat-list-item
                        class="subQuestionList"
                        *ngFor="let subQuestion of question.subQuestions"
                        [class]="subQuestion.tempId === currentQuestionDisplay?.tempId ? 'current-question' : ''"
                      >
                        <span>&#x2022; {{subQuestion.name}}</span>
                        <mat-icon
                          style="
                            cursor: pointer;
                            font-size: 16px;
                            margin-left: 10px;
                          "
                          #tooltip="matTooltip"
                          matTooltip="Edit question"
                          (click)="editQuestion(question, subQuestion)"
                          >edit</mat-icon
                        >
                        <mat-icon
                          style="cursor: pointer; font-size: 16px"
                          #tooltip="matTooltip"
                          matTooltip="Delete question"
                          (click)="deleteQuestion(question, subQuestion)"
                          >delete</mat-icon
                        >
                        <mat-icon
                          style="cursor: pointer; font-size: 16px"
                          #tooltip="matTooltip"
                          matTooltip="Preview question"
                          (click)="previewQuestion()"
                          *ngIf="subQuestion.tempId === currentQuestionDisplay?.tempId"
                          >remove_red_eye</mat-icon
                        >
                      </mat-list-item>
                      <span
                        style="
                          display: flex;
                          align-items: center;
                          font-size: small;
                          cursor: pointer;
                        "
                        class="subQuestionList"
                        (click)="addQuestionToSection(question)"
                        ><mat-icon>add</mat-icon
                        ><b>Add question to section</b></span
                      >
                    </div>
                  </mat-list>
                </div>

                <mat-divider
                  *ngIf="questionList.length>0 && currentQuestionDisplay"
                ></mat-divider>

                <!----- Add Question/Section to List Buttons: ----->
                <div class="tree-button-container">
                  <button
                    mat-raised-button
                    type="button"
                    class="button add-new-question-button"
                    (click)="addNewQuestion()"
                  >
                    <mat-icon>add</mat-icon>
                    <span
                      [class]="questionList.length>0 && currentQuestionDisplay ? 'new-question-text' : ''"
                      >Add New Question</span
                    >
                  </button>
                  <button
                    mat-raised-button
                    type="button"
                    (click)="addNewSection()"
                    class="button add-new-question-button"
                  >
                    <mat-icon>add</mat-icon
                    ><span
                      [class]="questionList.length>0 && currentQuestionDisplay ? 'new-question-text' : ''"
                      >Add New Section</span
                    >
                  </button>
                </div>
              </div>
            </div>

            <!----- ---------------------- ----->
            <!----- Questions  Display Box ----->
            <!----- ---------------------- ----->

            <div
              class="question-container mat-elevation-z4"
              [class]="questionList.length>0 && currentQuestionDisplay ? 'col-sm-7 offset-1' : 'col-0'"
              [class.exam-form-loading-overlay]="changingQuestions"
              *ngIf="questionList.length>0 && currentQuestionDisplay"
            >
              <!----- Question Name Form: ----->
              <mat-form-field class="form-field" appearance="outline">
                <mat-label>Question name</mat-label>
                <input
                  matInput
                  id="questionName"
                  #questionName
                  formControlName="questionName"
                  type="text"
                  placeholder="E.g. Question 1 - Multiple Choice"
                  required
                  (keyup)="formChange(questionName.value, 'name')"
                />
                <mat-error>
                  <app-error-message
                    [control]="questionStepForm.controls['questionName'].errors"
                  ></app-error-message>
                </mat-error>
              </mat-form-field>

              <!----- Question Type Form: ----->
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>Question Type</mat-label>
                <mat-select
                  formControlName="type"
                  (selectionChange)="formChange($event.value, 'type')"
                  [disabled]="currentQuestionDisplay.type?.toLowerCase() === 'section'"
                >
                  <ng-container *ngFor="let questionType of questionTypes">
                    <ng-container
                      *ngIf="questionType.type !== 'section' || currentQuestionDisplay?.type === 'section'"
                    >
                      <mat-option
                        [value]="questionType.type"
                        #tooltip="matTooltip"
                        [matTooltip]="questionType.description"
                        [matTooltipPosition]="'left'"
                        >{{questionType.label}}</mat-option
                      >
                    </ng-container>
                  </ng-container>
                </mat-select>
                <mat-error>
                  <app-error-message
                    [control]="questionStepForm.controls['type'].errors"
                  ></app-error-message>
                </mat-error>
              </mat-form-field>

              <!----- Question Time Limit: ----->
              <mat-form-field
                class="form-field"
                appearance="outline"
                *ngIf="['written-response','audio-response','repeat-sentence', 'read-outloud'].includes(questionStepForm.getRawValue().type.toLowerCase())"
              >
                <mat-label
                  *ngIf="questionStepForm.getRawValue().type === 'written-response'"
                  >Response word limit</mat-label
                >
                <mat-label
                  *ngIf="['audio-response','repeat-sentence', 'read-outloud'].includes(questionStepForm.getRawValue().type.toLowerCase())"
                  >Response time limit (seconds)</mat-label
                >
                <input
                  matInput
                  id="length"
                  #length
                  formControlName="length"
                  type="number"
                  [placeholder]="questionStepForm.getRawValue().type === 'written-response' ? 'Enter word limit' : 'Enter audio response time (seconds)'"
                  (change)="formChange(length.value, 'length')"
                  [attr.max]="questionStepForm.getRawValue().type === 'written-response' ? maxWrittenResponseWordLimit : maxAudioResponseTimeLimit"
                />
                <mat-error>
                  <app-error-message
                    [control]="questionStepForm.controls['length'].errors"
                  ></app-error-message>
                </mat-error>
              </mat-form-field>

              <mat-form-field
                class="form-field"
                appearance="outline"
                *ngIf="currentQuestionDisplay?.type?.toLowerCase() === 'read-outloud'"
              >
                <mat-label>Question prompt</mat-label>
                <textarea
                  matInput
                  type="text"
                  disabled
                  [value]="readOutloudQuestionPrompt"
                  rows="4"
                ></textarea>
              </mat-form-field>

              <!----- Question Prompt (written): ----->
              <mat-form-field class="form-field" appearance="outline">
                <mat-label
                  *ngIf="!['section', 'read-outloud'].includes(currentQuestionDisplay?.type?.toLowerCase() ?? '')"
                  >Question prompt</mat-label
                >
                <mat-label
                  *ngIf="currentQuestionDisplay?.type?.toLowerCase() === 'section'"
                  >Section prompt</mat-label
                >
                <mat-label
                  *ngIf="currentQuestionDisplay?.type?.toLowerCase() === 'read-outloud'"
                  >Text to read out loud</mat-label
                >
                <!-- <input
                  matInput
                  id="writtenPrompt"
                  formControlName="writtenPrompt"
                  #writtenPrompt
                  type="text"
                  placeholder="A short description of the question/section"
                  required
                  (keyup)="formChange(writtenPrompt.value, 'writtenPrompt')"
                /> -->
                <textarea
                  matInput
                  id="writtenPrompt"
                  formControlName="writtenPrompt"
                  #writtenPrompt
                  type="text"
                  rows="3"
                  [placeholder]="currentQuestionDisplay.type?.toLowerCase() === 'read-outloud' ? 'Add the text that the student will have to read out loud here.' : 'A short description of the question/section'"
                  required
                  (keyup)="formChange(writtenPrompt.value, 'writtenPrompt')"
                ></textarea>

                <button
                  *ngIf="['read-outloud', 'essay', 'written-response', 'audio-response'].includes(currentQuestionDisplay.type?.toLowerCase() ?? '')"
                  mat-icon-button
                  matSuffix
                  matTooltip="Generate AI prompt"
                  matTooltipPosition="after"
                  (click)="openAiPromptGeneratorClick()"
                >
                  <mat-icon>smart_button</mat-icon>
                </button>

                <mat-error>
                  <app-error-message
                    [control]="questionStepForm.controls['writtenPrompt'].errors"
                  ></app-error-message>
                </mat-error>
              </mat-form-field>

              <!----- Question/Section Total Points: ----->
              <div
                *ngIf="currentQuestionDisplay?.type?.toLowerCase() !== 'information-page'"
              >
                <mat-form-field
                  class="form-field"
                  appearance="outline"
                  class="col"
                  style="width: 47.5%"
                >
                  <mat-label>Total Points (min)</mat-label>
                  <input
                    matInput
                    id="totalPointsMin"
                    formControlName="totalPointsMin"
                    #totalPointsMin
                    type="number"
                    (keyup)="formChange(totalPointsMin.value, 'totalPointsMin')"
                    placeholder="The smallest number of points a student can be awarded for this question/section. The default is 0"
                  />
                  <mat-error>
                    <app-error-message
                      [control]="questionStepForm.controls['totalPointsMin'].errors"
                    ></app-error-message>
                  </mat-error>
                </mat-form-field>

                <span style="width: 10%">&nbsp; - &nbsp;</span>

                <mat-form-field
                  class="form-field"
                  appearance="outline"
                  class="col"
                  style="width: 47.5%"
                >
                  <mat-label>Total Points (max)</mat-label>
                  <input
                    matInput
                    id="totalPointsMax"
                    formControlName="totalPointsMax"
                    #totalPointsMax
                    type="number"
                    (keyup)="formChange(totalPointsMax.value, 'totalPointsMax')"
                    placeholder="The total amount of points this question/section will be marked out of. The default is 5."
                  />
                  <mat-error>
                    <app-error-message
                      [control]="questionStepForm.controls['totalPointsMax'].errors"
                    ></app-error-message>
                  </mat-error>
                </mat-form-field>
              </div>

              <div
                *ngIf="
                  !currentQuestionDisplay.prompt1 && 
                  !currentQuestionDisplay.prompt2 && 
                  currentQuestionDisplay.type !== 'read-outloud'
                "
                class="form-field"
                style="margin-bottom: 60px"
              >
                <span style="cursor: pointer" (click)="addNewPrompt()"
                  ><mat-icon>add</mat-icon> Add media prompt</span
                >
                <mat-icon
                  matTooltip="Add one or more media prompts to this question (e.g. an audio file or an image)."
                  matTooltipPosition="after"
                  >info_outlined</mat-icon
                >
              </div>

              <!----- Question Prompt1: ----->
              <div *ngIf="currentQuestionDisplay.prompt1">
                <mat-form-field appearance="outline" style="width: 70%">
                  <mat-label for="prompt1" class="file-label"
                    ><mat-icon>attach_file</mat-icon>
                    <span *ngIf="!fileNamePrompt1">Prompt Attachment...</span>
                    <span *ngIf="fileNamePrompt1">{{fileNamePrompt1}}</span>
                  </mat-label>
                  <input
                    #prompt1
                    type="file"
                    hidden="true"
                    (change)="updatePrompt($event, 'prompt1', 'prompt1Type')"
                    [accept]="getAcceptedFileTypes(questionStepForm.getRawValue().prompt1Type)"
                  />
                  <input
                    matInput
                    [placeholder]="fileNamePrompt1 || 'Upload an audio or visual prompt for this question'"
                    (click)="prompt1.click()"
                    readonly
                  />

                  <button
                    *ngIf="questionStepForm.controls['prompt1Type'].value?.toLowerCase() === 'audio'"
                    mat-icon-button
                    matSuffix
                    matTooltip="Generate AI prompt"
                    matTooltipPosition="after"
                    (click)="openAiPromptGeneratorClick(true)"
                  >
                    <mat-icon>smart_button</mat-icon>
                  </button>

                  <button
                    mat-icon-button
                    matSuffix
                    matTooltip="Add a new prompt"
                    matTooltipPosition="after"
                    (click)="addNewPrompt()"
                    *ngIf="!currentQuestionDisplay.prompt2 && currentQuestionDisplay?.type !== 'repeat-sentence'"
                  >
                    <mat-icon>add</mat-icon>
                  </button>
                  <button
                    mat-icon-button
                    matSuffix
                    matTooltip="Remove prompt"
                    matTooltipPosition="after"
                    *ngIf="!currentQuestionDisplay.prompt2 && currentQuestionDisplay?.type !== 'repeat-sentence'"
                    (click)="removePrompt('prompt1')"
                  >
                    <mat-icon>delete</mat-icon>
                  </button>
                  <mat-error>
                    <app-error-message
                      [control]="questionStepForm.controls['prompt1'].errors"
                    ></app-error-message>
                  </mat-error>
                </mat-form-field>

                <mat-form-field
                  appearance="outline"
                  style="width: 25%; margin-left: 5%"
                >
                  <mat-label>Prompt Type</mat-label>
                  <mat-select
                    formControlName="prompt1Type"
                    (selectionChange)="updatePromptType($event.value, 'prompt1', true)"
                    [disabled]="currentQuestionDisplay.type === 'repeat-sentence'"
                  >
                    <mat-option
                      *ngFor="let promptType of ['image', 'audio']"
                      [value]="promptType"
                      >{{promptType | titlecase}}</mat-option
                    >
                  </mat-select>
                </mat-form-field>
              </div>

              <!----- Question Prompt2: ----->
              <div *ngIf="currentQuestionDisplay.prompt2">
                <mat-form-field appearance="outline" style="width: 70%">
                  <mat-label for="prompt2" class="file-label"
                    ><mat-icon>attach_file</mat-icon>
                    <span *ngIf="!fileNamePrompt2">Prompt Attachment...</span>
                    <span *ngIf="fileNamePrompt2">{{fileNamePrompt2}}</span>
                  </mat-label>
                  <input
                    #prompt2
                    type="file"
                    hidden="true"
                    (change)="updatePrompt($event, 'prompt2', 'prompt2Type')"
                    [accept]="getAcceptedFileTypes(questionStepForm.getRawValue().prompt2Type)"
                  />
                  <input
                    matInput
                    [placeholder]="fileNamePrompt2 || 'Upload another audio or visual prompt for this question'"
                    (click)="prompt2.click()"
                    readonly
                  />
                  <button
                    mat-icon-button
                    matSuffix
                    matTooltip="Add a new prompt"
                    matTooltipPosition="after"
                    (click)="addNewPrompt()"
                    *ngIf="!currentQuestionDisplay.prompt3"
                  >
                    <mat-icon>add</mat-icon>
                  </button>
                  <button
                    mat-icon-button
                    matSuffix
                    matTooltip="Remove prompt"
                    matTooltipPosition="after"
                    (click)="removePrompt('prompt2')"
                    *ngIf="!currentQuestionDisplay.prompt3"
                  >
                    <mat-icon>delete</mat-icon>
                  </button>
                  <mat-error>
                    <app-error-message
                      [control]="questionStepForm.controls['prompt2'].errors"
                    ></app-error-message>
                  </mat-error>
                </mat-form-field>

                <mat-form-field
                  appearance="outline"
                  style="width: 25%; margin-left: 5%"
                >
                  <mat-label>Prompt Type</mat-label>
                  <mat-select
                    formControlName="prompt2Type"
                    (selectionChange)="updatePromptType($event.value, 'prompt2', true)"
                  >
                    <mat-option
                      *ngFor="let promptType of ['image', 'audio']"
                      [value]="promptType"
                      >{{promptType | titlecase}}</mat-option
                    >
                  </mat-select>
                </mat-form-field>
              </div>

              <!----- Question Prompt3: ----->
              <div *ngIf="currentQuestionDisplay.prompt3">
                <mat-form-field appearance="outline" style="width: 70%">
                  <mat-label for="prompt3" class="file-label"
                    ><mat-icon>attach_file</mat-icon>
                    <span *ngIf="!fileNamePrompt2">Prompt Attachment...</span>
                    <span *ngIf="fileNamePrompt2">{{fileNamePrompt3}}</span>
                  </mat-label>
                  <input
                    #prompt3
                    type="file"
                    hidden="true"
                    (change)="updatePrompt($event, 'prompt3', 'prompt3Type')"
                    [accept]="getAcceptedFileTypes(questionStepForm.getRawValue().prompt3Type)"
                  />
                  <input
                    matInput
                    [placeholder]="fileNamePrompt3 || 'Upload another audio or visual prompt for this question'"
                    (click)="prompt3.click()"
                    readonly
                  />
                  <button
                    mat-icon-button
                    matSuffix
                    matTooltip="Remove prompt"
                    matTooltipPosition="after"
                    (click)="removePrompt('prompt3')"
                  >
                    <mat-icon>delete</mat-icon>
                  </button>
                  <mat-error>
                    <app-error-message
                      [control]="questionStepForm.controls['prompt3'].errors"
                    ></app-error-message>
                  </mat-error>
                </mat-form-field>

                <mat-form-field
                  appearance="outline"
                  style="width: 25%; margin-left: 5%"
                >
                  <mat-label>Prompt Type</mat-label>
                  <mat-select
                    formControlName="prompt3Type"
                    (selectionChange)="updatePromptType($event.value, 'prompt3', true)"
                  >
                    <mat-option
                      *ngFor="let promptType of ['image', 'audio']"
                      [value]="promptType"
                      >{{promptType | titlecase}}</mat-option
                    >
                  </mat-select>
                </mat-form-field>
              </div>

              <!----- Teacher Feedback Toggle: ----->
              <form
                [formGroup]="questionStepForm"
                class="form-field"
                *ngIf="!['section','information-page'].includes(currentQuestionDisplay?.type?.toLowerCase() ?? '')"
              >
                <mat-slide-toggle
                  id="teacherFeedback"
                  #teacherFeedback
                  name="teacherFeedback"
                  formControlName="teacherFeedback"
                  (change)="formChange(teacherFeedback.checked, 'teacherFeedback')"
                  [checked]="currentQuestionDisplay.teacherFeedback"
                >
                  Feedback required?
                  <mat-icon
                    style="font-size: 20px"
                    #tooltip="matTooltip"
                    matTooltip="When turned on, the teacher will be prompted to give written feedback to the student for this question."
                    >info_outlined</mat-icon
                  >
                </mat-slide-toggle>
                <mat-error>
                  <app-error-message
                    [control]="questionStepForm.controls['teacherFeedback'].errors"
                  ></app-error-message>
                </mat-error>
              </form>

              <!----- Auto Marking Toggle: ----->
              <form
                [formGroup]="questionStepForm"
                class="form-field"
                *ngIf="
                  !['section','information-page'].includes(currentQuestionDisplay?.type?.toLowerCase() ?? '') &&
                  !['multiple-choice-single', 'multiple-choice-multi', 'reorder-sentence', 'match-options'].includes(currentQuestionDisplay.type ?? '')
                  "
              >
                <mat-slide-toggle
                  formControlName="autoMarking"
                  id="autoMarking"
                  name="autoMarking"
                  #autoMarking
                  (change)="formChange(autoMarking.checked, 'autoMarking')"
                  [checked]="currentQuestionDisplay.autoMarking"
                >
                  <span *ngIf="!currentQuestionDisplay?.teacherFeedback"
                    >Auto marking?</span
                  >
                  <span *ngIf="currentQuestionDisplay?.teacherFeedback"
                    >Auto marking/feedback?</span
                  >

                  <mat-icon
                    style="font-size: 20px"
                    #tooltip="matTooltip"
                    [matTooltip]="currentQuestionDisplay.teacherFeedback ? 'When turned on, this question will automatically be marked by our ai marking software and the student will be given a score and feedback. When turned off, the teacher must provide the student with a score/feedback.' : 'When turned on, this question will automatically be marked by our marking software and the student will be given a score. When turned off, the teacher must provide the student with a score.'"
                    >info_outlined</mat-icon
                  >
                </mat-slide-toggle>
              </form>

              <!----- Auto Feedback Toggle (for multichoice answer quesitons only): ----->
              <form
                [formGroup]="questionStepForm"
                class="form-field"
                *ngIf="
                  !['section','information-page'].includes(currentQuestionDisplay?.type?.toLowerCase() ?? '') &&
                  ['multiple-choice-single', 'multiple-choice-multi', 'reorder-sentence', 'match-options'].includes(currentQuestionDisplay.type ?? '') &&
                  currentQuestionDisplay?.teacherFeedback
                  "
              >
                <mat-slide-toggle
                  formControlName="autoMarking"
                  id="autoMarking"
                  name="autoMarking"
                  #autoMarking
                  (change)="formChange(autoMarking.checked, 'autoMarking')"
                  [checked]="currentQuestionDisplay.autoMarking"
                >
                  <span>Auto feedback?</span>

                  <mat-icon
                    style="font-size: 20px"
                    #tooltip="matTooltip"
                    matTooltip="When turned on, this question will automatically be marked by our ai marking software and the student will be given feedback. When turned off, the teacher must provide the student with feedback."
                    >info_outlined</mat-icon
                  >
                </mat-slide-toggle>
                <mat-error>
                  <app-error-message
                    [control]="questionStepForm.controls['autoMarking'].errors"
                  ></app-error-message>
                </mat-error>
              </form>

              <!----- Question Timelimit Toggle: ----->
              <div class="form-field">
                <mat-slide-toggle
                  id="timed"
                  name="timed"
                  #timed
                  (change)="formChange(timed.checked, 'timed')"
                  [checked]="currentQuestionDisplay.timed"
                >
                  Timed?
                  <mat-icon
                    *ngIf="!currentQuestionDisplay.timed"
                    style="font-size: 20px"
                    #tooltip="matTooltip"
                    matTooltip="When turned on, this question/section will have a time limit"
                    >info_outlined</mat-icon
                  >
                </mat-slide-toggle>
              </div>

              <!----- Question Time limit : ----->
              <mat-form-field
                class="form-field"
                appearance="outline"
                *ngIf="currentQuestionDisplay?.timed"
              >
                <mat-label>Time limit (seconds)</mat-label>
                <input
                  matInput
                  id="time"
                  #time
                  formControlName="time"
                  type="text"
                  placeholder="Time limit (seconds)"
                  [required]="currentQuestionDisplay.timed === true"
                  (keyup)="formChange(time.value, 'time')"
                />
                <mat-error>
                  <app-error-message
                    [control]="questionStepForm.controls['time'].errors"
                  ></app-error-message>
                </mat-error>
              </mat-form-field>

              <!------------------------------------>
              <!----- Add-to-question Buttons: ----->
              <!------------------------------------>
              <div class="add-to-question-btn">
                <button
                  mat-raised-button
                  type="button"
                  class="button"
                  (click)="openQuestionDetailDialog()"
                >
                  <!----- Add Multi Choice Options : ----->
                  <div
                    *ngIf="['multiple-choice-single', 'multiple-choice-multi'].includes(
                    currentQuestionDisplay?.type ?? ''
                  )"
                  >
                    <span
                      *ngIf="!currentQuestionDisplay.multipleChoiceQuestionList || currentQuestionDisplay.multipleChoiceQuestionList.length === 0"
                      >Add Multiple Choice Options</span
                    >
                    <span
                      *ngIf="(currentQuestionDisplay.multipleChoiceQuestionList ?? []).length > 0"
                      >Edit Multiple Choice Options</span
                    >
                    <i
                      style="padding-left: 5px"
                      *ngIf="(currentQuestionDisplay.multipleChoiceQuestionList ?? []).length > 0"
                      >({{((currentQuestionDisplay.multipleChoiceQuestionList ??
                      [])).length}} multi-choice options added)</i
                    >
                  </div>

                  <!----- Add Reorder Sentence Options : ----->
                  <div
                    *ngIf="currentQuestionDisplay?.type === 'reorder-sentence'"
                  >
                    <span
                      *ngIf="!currentQuestionDisplay.reorderSentenceQuestionList || currentQuestionDisplay.reorderSentenceQuestionList.length === 0"
                      >Add Reorder Sentence Options</span
                    >
                    <span
                      *ngIf="(currentQuestionDisplay.reorderSentenceQuestionList ?? []).length > 0"
                      >Edit Reorder Sentence Options</span
                    >
                    <i
                      style="padding-left: 5px"
                      *ngIf="(currentQuestionDisplay.reorderSentenceQuestionList ?? []).length > 0"
                      >({{((currentQuestionDisplay.reorderSentenceQuestionList
                      ?? [])).length}} sentences added)</i
                    >
                  </div>

                  <!----- Add Match Options : ----->
                  <div *ngIf="currentQuestionDisplay?.type === 'match-options'">
                    <span
                      *ngIf="!currentQuestionDisplay.matchOptionQuestionList || currentQuestionDisplay.matchOptionQuestionList.length === 0"
                      >Add Match Options</span
                    >
                    <span
                      *ngIf="(currentQuestionDisplay.matchOptionQuestionList ?? []).length > 0"
                      >Edit Match Options</span
                    >
                    <i
                      style="padding-left: 5px"
                      *ngIf="(currentQuestionDisplay.matchOptionQuestionList ?? []).length > 0"
                      >({{((currentQuestionDisplay.matchOptionQuestionList ??
                      [])).length}} options added)</i
                    >
                  </div>

                  <!----- Add Fill in Blanks : ----->
                  <div
                    *ngIf="['fill-in-the-blanks', 'fill-in-blanks-select'].includes(currentQuestionDisplay?.type ?? '')"
                  >
                    <span
                      *ngIf="!currentQuestionDisplay.fillBlanksQuestionList || currentQuestionDisplay.fillBlanksQuestionList.length === 0"
                      >Add Fill-in-the-Blanks Questions</span
                    >
                    <span
                      *ngIf="(currentQuestionDisplay.fillBlanksQuestionList ?? []).length > 0"
                      >Edit Fill-in-the-Blanks Questions</span
                    >
                    <i
                      style="padding-left: 5px"
                      *ngIf="(currentQuestionDisplay.fillBlanksQuestionList ?? []).length > 0"
                      >({{((currentQuestionDisplay.fillBlanksQuestionList ??
                      [])).length}} options added)</i
                    >
                  </div>
                </button>
              </div>
            </div>
          </div>
        </mat-dialog-content>

        <!----- Question Stepper Nav: ----->
        <mat-dialog-actions align="end">
          <button mat-button matStepperPrevious type="button">Back</button>
          <button
            mat-raised-button
            type="button"
            class="button"
            (click)="saveExamClick()"
          >
            <b>Save Exam</b>
          </button>
        </mat-dialog-actions>
      </mat-step>
    </div>
  </mat-stepper>
  <!-- <mat-dialog-actions align="end">
    <button mat-button color="primary" [mat-dialog-close]="false">Cancel</button>
    <button
      class="okButton"
      mat-raised-button
      cdkFocusInitial
      [mat-dialog-close]="this.examForm.value"
      [disabled]="this.examForm.invalid"
    >
      Save
    </button>
  </mat-dialog-actions> -->
</ng-container>
